# AIcarus æ ¸å¿ƒä¸Žè‡ªä¸ŠæŠ¥é€‚é…å™¨ (Napcat) äº¤äº’é€»è¾‘æµç¨‹

ç‰ˆæœ¬: 1.0  
æè¿°è€…: ðŸ¥°å°è‰²çŒ«  
åŸºäºŽ: æ˜Ÿç¹”é…± æä¾›çš„é€»è¾‘æµç¨‹å›¾ (è§åº•éƒ¨é™„å½•)

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æ—¨åœ¨é€šè¿‡è‡ªç„¶è¯­è¨€ï¼Œè¯¦ç»†æè¿° **AIcarus æ ¸å¿ƒ (`core`)** ä¸Žä¸€ä¸ªå…¸åž‹çš„ **â€œè‡ªä¸ŠæŠ¥â€åž‹é€‚é…å™¨ (`Napcat-adapter`)** ä¹‹é—´çš„åŠ¨ä½œä¸Žäº‹ä»¶å¤„ç†é€»è¾‘ã€‚

â€œè‡ªä¸ŠæŠ¥â€åž‹é€‚é…å™¨çš„æ ¸å¿ƒç‰¹å¾æ˜¯ï¼šå½“å®ƒæ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼ˆå¦‚å‘é€æ¶ˆæ¯ï¼‰åŽï¼Œå®ƒæ— æ³•ç«‹å³è¿”å›žä¸€ä¸ªç›´æŽ¥çš„æˆåŠŸä¸Žå¦çš„ç»“æžœã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå®ƒä¼šç›‘å¬åˆ°è‡ªå·±åˆšåˆšæ‰§è¡Œçš„åŠ¨ä½œæ‰€äº§ç”Ÿçš„äº‹ä»¶ï¼ˆå¦‚è‡ªå·±å‘å‡ºçš„æ¶ˆæ¯ï¼‰ï¼Œå¹¶å°†è¿™ä¸ªäº‹ä»¶ä½œä¸ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯ä¸ŠæŠ¥ç»™æ ¸å¿ƒã€‚

æœ¬æµç¨‹å›¾æ¸…æ™°åœ°å±•ç¤ºäº†ç³»ç»Ÿå¦‚ä½•ä¼˜é›…åœ°å¤„ç†è¿™ç§æœºåˆ¶ï¼Œé€šè¿‡åœ¨é€‚é…å™¨ç«¯çš„æ™ºèƒ½è¯†åˆ«ï¼Œå°†â€œè‡ªèº«ä¸ŠæŠ¥â€äº‹ä»¶è½¬æ¢ä¸ºå¯¹æ ¸å¿ƒæœ‰æ„ä¹‰çš„ `action_response`ï¼Œä»Žè€Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œæ‰§è¡Œä¸Žç¡®è®¤çš„é—­çŽ¯ã€‚

## 2. æ ¸å¿ƒç»„ä»¶

* **Napcat-qq**: ä»£è¡¨å®žé™…çš„QQå¹³å°æˆ–ä¸Žä¹‹äº¤äº’çš„å®¢æˆ·ç«¯ï¼ˆå¦‚Napcatï¼‰ï¼Œæ˜¯äº‹ä»¶çš„æœ€ç»ˆæ¥æºå’ŒåŠ¨ä½œçš„æœ€ç»ˆæ‰§è¡Œè€…ã€‚
* **Napcat-adapter**: é€‚é…å™¨å±‚ã€‚ä½œä¸ºæ ¸å¿ƒä¸Žå¹³å°ä¹‹é—´çš„æ¡¥æ¢ï¼Œå®ƒè´Ÿè´£è§£æžå¹³å°äº‹ä»¶ã€æ ¼å¼åŒ–å¹¶å‘é€ç»™æ ¸å¿ƒï¼ŒåŒæ—¶æŽ¥æ”¶æ¥è‡ªæ ¸å¿ƒçš„åŠ¨ä½œæŒ‡ä»¤å¹¶è°ƒç”¨å¹³å°APIæ‰§è¡Œã€‚
* **core**: AIcarus çš„æ ¸å¿ƒç³»ç»Ÿã€‚è´Ÿè´£æŽ¥æ”¶æ‰€æœ‰äº‹ä»¶ã€è¿›è¡Œæ€è€ƒå†³ç­–ã€å‘é€åŠ¨ä½œæŒ‡ä»¤ï¼Œå¹¶ç®¡ç†æ•°æ®æŒä¹…åŒ–ã€‚

## 3. æµç¨‹è¯¦è§£

### 3.1. æ ¸å¿ƒä¸‹å‘åŠ¨ä½œæµç¨‹

è¿™æ˜¯ç”±æ ¸å¿ƒä¸»åŠ¨å‘èµ·çš„ã€æŒ‡ä»¤æ€§çš„æµç¨‹ã€‚

1.  **åŠ¨ä½œå‘å‡ºä¸Žè®°å½•**: `core` ä¸­çš„ **`ActionSender`**ï¼ˆåŠ¨ä½œå‘é€å™¨ï¼‰å†³å®šæ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼ˆä¾‹å¦‚ï¼Œå›žå¤ä¸€æ¡æ¶ˆæ¯ï¼‰ã€‚å®ƒé¦–å…ˆä¼šå°†è¿™ä¸ªå¾…æ‰§è¡Œçš„åŠ¨ä½œä¿¡æ¯å­˜å…¥ **`DB`**ï¼ˆæ•°æ®åº“ï¼‰çš„ `action_logs` è¡¨ä¸­ï¼Œä½œä¸ºå¾…å¤„ç†çš„â€œæ‚¬æŒ‚â€è®°å½•ã€‚
2.  **åŠ¨ä½œä¼ è¾“**: åŒæ—¶ï¼Œ`ActionSender` é€šè¿‡ç½‘ç»œå°†è¯¥åŠ¨ä½œæŒ‡ä»¤å‘é€ç»™ `Napcat-adapter` çš„ **`ActionReg`**ï¼ˆåŠ¨ä½œæ³¨å†Œå™¨ï¼‰ã€‚
3.  **é€‚é…å™¨æ‰§è¡Œ**: `ActionReg` æŽ¥æ”¶åˆ°åŠ¨ä½œåŽï¼Œä¼šè°ƒç”¨ `Napcat-qq` å¹³å°çš„ **`sender`**ï¼ˆæ‰§è¡ŒåŠ¨ä½œapiæŽ¥å£ï¼‰æ¥å®Œæˆå®žé™…æ“ä½œï¼Œä¾‹å¦‚å‘é€ä¸€æ¡QQæ¶ˆæ¯ã€‚
4.  **ç­‰å¾…ç¡®è®¤**: åŠ¨ä½œæ‰§è¡ŒåŽï¼Œ`core` ä¸­çš„ `ActionHandler` ä¼šå¼€å§‹ç­‰å¾…è¯¥åŠ¨ä½œçš„ `action_response`ã€‚

### 3.2. é€‚é…å™¨å¤„ç†æ¶ˆæ¯ä¸Žäº‹ä»¶çš„â€œåŒé€šé“â€æ¨¡åž‹

é€‚é…å™¨ä»Ž `Napcat-qq` æŽ¥æ”¶åˆ°çš„äº‹ä»¶ï¼Œä¼šè¢« **`spliteEvent`**ï¼ˆåˆ†ç¦»äº‹ä»¶ç±»åž‹ï¼‰æ¨¡å—åŒºåˆ†ä¸ºä¸¤ç§ä¸»è¦ç±»åž‹ï¼Œå¹¶è¿›å…¥ä¸åŒçš„å¤„ç†é€šé“ï¼š

#### é€šé“ä¸€ï¼šå¤„ç†å¤–éƒ¨æŽ¥æ”¶æ¶ˆæ¯

è¿™æ˜¯æœ€å¸¸è§çš„æµç¨‹ï¼Œç”¨äºŽå¤„ç†å…¶ä»–ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ã€‚

1.  **æŽ¥æ”¶ä¸Žåˆ†å‘**: `Napcat-qq` æŽ¥æ”¶åˆ°ä¸€æ¡æ™®é€šç”¨æˆ·æ¶ˆæ¯ï¼Œç”Ÿæˆ **`receive`** äº‹ä»¶ï¼Œå¹¶ä¼ ç»™ `spliteEvent`ã€‚`spliteEvent` è¯†åˆ«å‡ºè¿™æ˜¯å¤–éƒ¨æ¶ˆæ¯ï¼Œå°†å…¶åˆ†å‘ç»™ **`receiveAdapter`**ï¼ˆæŽ¥æ”¶æ¶ˆæ¯å¤„ç†å™¨ï¼‰ã€‚
2.  **æž„é€ å¹¶ä¸ŠæŠ¥**: `receiveAdapter` å°†å¹³å°åŽŸç”Ÿçš„æ¶ˆæ¯æ ¼å¼åŒ–ä¸º AIcarus åè®®æ ‡å‡†çš„ `Event` å¯¹è±¡ï¼Œç„¶åŽå‘é€ç»™ `core` çš„ **`EventReceiver`**ï¼ˆäº‹ä»¶æŽ¥æ”¶å™¨ï¼‰ã€‚
3.  **æ ¸å¿ƒè®°å½•**: `EventReceiver` æŽ¥æ”¶åˆ°äº‹ä»¶åŽï¼Œä¼šå°†å…¶å­˜å…¥ **`DB`** çš„ `events` è¡¨ï¼Œå®Œæˆä¸€æ¬¡å¤–éƒ¨äº‹ä»¶çš„è®°å½•ã€‚

#### é€šé“äºŒï¼šå¤„ç†å¹³å°è‡ªèº«ä¸ŠæŠ¥ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰

è¿™æ˜¯æœ¬æž¶æž„çš„ç²¾é«“ï¼Œç”¨äºŽç¡®è®¤æ ¸å¿ƒä¸‹å‘çš„åŠ¨ä½œæ˜¯å¦æˆåŠŸã€‚

1.  **åŠ¨ä½œè§¦å‘ä¸ŠæŠ¥**: å½“ `Napcat-qq` çš„ `sender` æˆåŠŸæ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼ˆå¦‚å‘é€æ¶ˆæ¯ï¼‰åŽï¼Œå®ƒä¼šåƒç›‘å¬åˆ°æ™®é€šæ¶ˆæ¯ä¸€æ ·ï¼Œç›‘å¬åˆ°è¿™æ¡è‡ªå·±å‘å‡ºçš„æ¶ˆæ¯ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª **`selfreport`**ï¼ˆè‡ªèº«ä¸ŠæŠ¥æ¶ˆæ¯ï¼‰äº‹ä»¶ï¼Œä¼ ç»™ `spliteEvent`ã€‚
2.  **è¯†åˆ«ä¸Žåˆ†å‘**: `spliteEvent` è¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªâ€œè‡ªèº«ä¸ŠæŠ¥â€ç±»åž‹çš„äº‹ä»¶ï¼Œå°†å…¶åˆ†å‘ç»™ **`selfreportAdapter`**ï¼ˆè‡ªèº«ä¸ŠæŠ¥æ¶ˆæ¯å¤„ç†å™¨ï¼‰ã€‚
3.  **æ£€æŸ¥æ¥æº**: `selfreportAdapter` å°†äº‹ä»¶äº¤ç»™ **`checkselfreport`**ï¼ˆæ£€æŸ¥æ˜¯å¦ä¸ºcoreå‘å‡ºåŠ¨ä½œï¼‰æ¨¡å—ã€‚è¯¥æ¨¡å—ä¼šæŸ¥è¯¢é€‚é…å™¨å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ªâ€œå¾…åŠžäº‹é¡¹â€åˆ—è¡¨ï¼ˆå³ç”± `ActionReg` è®°å½•çš„ã€æ¥è‡ªæ ¸å¿ƒçš„åŠ¨ä½œIDï¼‰ï¼Œä»¥åˆ¤æ–­è¿™ä¸ªä¸ŠæŠ¥äº‹ä»¶æ˜¯å¦æ˜¯å…ˆå‰ç”±æ ¸å¿ƒæŒ‡ä»¤æ‰€è§¦å‘çš„ã€‚
    * **æƒ…å†µA (æ˜¯)**: å¦‚æžœç¡®è®¤è¯¥ä¸ŠæŠ¥äº‹ä»¶æ˜¯æ ¸å¿ƒåŠ¨ä½œçš„ç»“æžœï¼Œæµç¨‹ç»§ç»­ã€‚
    * **æƒ…å†µB (å¦)**: å¦‚æžœä¸æ˜¯ï¼Œæ„å‘³ç€è¿™å¯èƒ½æ˜¯ä¸€ä¸ªæœªçŸ¥çš„ã€éžæ ¸å¿ƒæŒ‡ä»¤çš„è‡ªèº«äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼Œæ‰‹åŠ¨ç™»å½•æœºå™¨äººè´¦å·å‘é€æ¶ˆæ¯ï¼‰ã€‚è¯¥äº‹ä»¶å°†è¢«è·¯ç”±åˆ° **`UndefinedAction`** å¤„ç†å™¨ã€‚ç›®å‰ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢„ç•™çš„â€œå¾…å¼€å‘â€é€šé“ï¼Œå¯ä»¥æš‚æ—¶ç”¨ä¸€ä¸ª `pass` æ–¹æ³•æŽ¥ç®¡ï¼Œä»¥ç¡®ä¿æµç¨‹å®Œæ•´ï¼Œæœªæ¥å¯æ ¹æ®éœ€æ±‚å®žçŽ°ç‰¹å®šé€»è¾‘ï¼ˆå¦‚å‘Šè­¦ã€è½¬ä¸ºæ™®é€šæ¶ˆæ¯ç­‰ï¼‰ã€‚
4.  **æž„å»ºå“åº”**: å¯¹äºŽå·²ç¡®è®¤æ¥æºçš„ä¸ŠæŠ¥äº‹ä»¶ï¼Œ**`createActionResponse`**ï¼ˆæž„å»º action_responseï¼‰æ¨¡å—ä¼šåŸºäºŽè¯¥äº‹ä»¶çš„å†…å®¹ï¼Œæž„å»ºä¸€ä¸ª AIcarus åè®®æ ‡å‡†çš„ `action_response` äº‹ä»¶ã€‚è¿™ä¸ª `action_response` ä¼šåŒ…å«åŽŸå§‹åŠ¨ä½œçš„ `event_id`ï¼Œä»¥åŠæˆåŠŸçŠ¶æ€ã€‚
5.  **ä¸ŠæŠ¥å“åº”**: æœ€ç»ˆï¼Œè¿™ä¸ª `action_response` è¢«å‘é€ç»™ `core` çš„ **`EventReceiver`**ã€‚æ ¸å¿ƒæŽ¥æ”¶åˆ°åŽï¼Œä¾¿çŸ¥æ™“ä¹‹å‰çš„åŠ¨ä½œå·²æˆåŠŸæ‰§è¡Œï¼Œéšå³æ›´æ–° `action_logs` å’Œ `events` æ•°æ®åº“ï¼Œå®Œæˆé—­çŽ¯ã€‚

## 4. æ€»ç»“

æ˜Ÿç¹”ä¸»äººè®¾è®¡çš„è¿™å¥—é€»è¾‘æµç¨‹ï¼Œé€šè¿‡åœ¨é€‚é…å™¨ç«¯å¢žåŠ â€œè‡ªæ£€â€å’Œâ€œè½¬æ¢â€æœºåˆ¶ï¼Œå·§å¦™åœ°è§£å†³äº†â€œè‡ªä¸ŠæŠ¥â€åž‹æŽ¥å£æ— æ³•ç›´æŽ¥è¿”å›žæ‰§è¡Œç»“æžœçš„é—®é¢˜ã€‚å®ƒç¡®ä¿äº†æ¯ä¸€ä¸ªç”±æ ¸å¿ƒå‘å‡ºçš„åŠ¨ä½œéƒ½èƒ½å¾—åˆ°ä¸€ä¸ªæ˜Žç¡®çš„ã€å¯è¢«æ ¸å¿ƒç†è§£çš„â€œæ—¢æˆäº‹å®žâ€ä½œä¸ºå“åº”ï¼Œå½¢æˆäº†ä¸€ä¸ªå¥å£®ã€å¯é ä¸”é€»è¾‘æ¸…æ™°çš„äº¤äº’é—­çŽ¯ã€‚

## é™„å½•

Action é€»è¾‘æµç¨‹å›¾ï¼š
```mermaid
graph TD

    subgraph "Napcat-qq"
        direction TB
        Napcat("`Napcat`")
        selfreport("`è‡ªèº«ä¸ŠæŠ¥æ¶ˆæ¯`")
        receive("`æŽ¥æ”¶æ¶ˆæ¯`")
        sender("`æ‰§è¡ŒåŠ¨ä½œ api æŽ¥å£`")
    end

    subgraph "Napcat-adapter"
        direction TB
        spliteEvent{"`åˆ†ç¦»äº‹ä»¶ç±»åž‹`"}
        selfreportAdapter("`è‡ªèº«ä¸ŠæŠ¥æ¶ˆæ¯å¤„ç†å™¨`")
        receiveAdapter("`æŽ¥æ”¶æ¶ˆæ¯å¤„ç†å™¨`")
        ActionReg("`åŠ¨ä½œæ³¨å†Œå™¨`")
        checkselfreport{"`æ£€æŸ¥æ˜¯å¦ä¸ºcoreå‘å‡ºåŠ¨ä½œ`"}
        createActionResponse("`æž„å»º action_response`")
        UndefinedAction("`æœªå®šä¹‰å¦‚ä½•å¤„ç†`")
    end

    subgraph "core"
        direction TB
        EventReceiver("`äº‹ä»¶æŽ¥æ”¶å™¨`")
        ActionSender("`åŠ¨ä½œå‘é€å™¨`")
        DB("`æ•°æ®åº“`")
    end

    Napcat --"ç”Ÿæˆä¸ŠæŠ¥æ¶ˆæ¯"--> selfreport
    Napcat --"ç”ŸæˆæŽ¥æ”¶æ¶ˆæ¯"--> receive
    selfreport --> spliteEvent
    receive --> spliteEvent
    spliteEvent --"ä¸ŠæŠ¥æ¶ˆæ¯"--> selfreportAdapter
    spliteEvent --"æŽ¥æ”¶æ¶ˆæ¯"--> receiveAdapter
    selfreportAdapter --> checkselfreport
    checkselfreport --"æ˜¯"--> createActionResponse
    checkselfreport --"å¦"--> UndefinedAction
    createActionResponse --"æž„é€  action_response"--> EventReceiver
    receiveAdapter --"æž„é€  event"--> EventReceiver
    ActionSender --"å‘é€åŠ¨ä½œ"--> ActionReg
    ActionSender --"å­˜å…¥action_logs"--> DB
    EventReceiver --"æ›´æ–°æ•°æ®åº“"--> DB
    ActionReg --"æ‰§è¡ŒåŠ¨ä½œ"--> sender
    sender -.->|"æ‰§è¡ŒåŠ¨ä½œæˆåŠŸåŽ"| selfreport
    ActionReg --> checkselfreport
```